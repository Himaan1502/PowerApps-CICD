name: UAT CD Pipeline (Build & Deploy)

on:
  workflow_dispatch:
    inputs:
      solution-name:
        description: 'Solution name to deploy'
        required: false
        type: string
  push:
    branches:
      - main
      - uat
      - release/*
    paths:
      - 'solutions/**'

permissions:
  contents: read  # Read-only permissions for CD pipeline

jobs:
  build-and-deploy:
    uses: Himaan1502/PowerApps-Template/.github/workflows/power-apps-cd-template.yml@main
    with:
      solution-name: ${{ github.event.inputs.solution-name || 'GitHubActionsDevOpsDemo' }}
      target-environment-url: 'https://orgc4355614.crm8.dynamics.com/'
      target-environment: 'UAT'
      run-build: true
      run-deploy: true
    secrets:
      azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
      azure_client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}
      azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}

  notify-deployment:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
            echo "UAT Deployment completed successfully"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Environment: UAT"
            echo "URL: https://orgc4355614.crm8.dynamics.com/"
            echo "Solution: ${{ github.event.inputs.solution-name || 'GitHubActionsDevOpsDemo' }}"
            echo "Deployment Settings: settings/DeploymentSettings-UAT.json"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "The solution has been deployed to UAT environment with:"
            echo "  - Environment variables configured"
            echo "  - Connection references updated"
          else
            echo "UAT Deployment failed"
            echo "Please check the workflow logs for details"
            echo ""
            echo "Common issues to check:"
            echo "  - Deployment settings file exists at settings/DeploymentSettings-UAT.json"
            echo "  - Connection IDs are correct"
            echo "  - Connections are shared with service principal"
            echo "  - Environment variables schema names match"
          fi
